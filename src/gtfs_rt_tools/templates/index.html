<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Vehicle Positions Map</title>
    <style>
        #map { height: 600px; }
        #logtime { 
            text-align: center; 
            font-size: 1.2em; 
            margin-bottom: 10px; 
            font-weight: bold;
        }
    </style>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
</head>
<body>
    <h1>Vehicle Positions Map</h1>
    <div id="logtime"></div>
    <div id="map"></div>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script>
        var map = L.map('map').setView([44.9778, -93.2650], 13);  // Set view to a default location
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

        function updateLogtime(logtime) {
            document.getElementById('logtime').textContent = 'Log Time: ' + logtime;
        }

        // Function to fetch vehicle positions and update the map
        function updateMap() {
            console.log('Fetching vehicle positions...');
            fetch('/vehicle_positions')
                .then(response => {
                    console.log('Response received:', response);
                    return response.json();
                })
                .then(data => {
                    console.log('Received vehicle data:', data);
                    if (data.error) {
                        console.error('Error in data:', data.error);
                        return;
                    }
                    updateLogtime(data.logtime);
                    if (!Array.isArray(data.vehicles) || data.vehicles.length === 0) {
                        console.warn('No vehicle data received or data is not an array');
                        return;
                    }
                    // Clear existing markers
                    map.eachLayer((layer) => {
                        if (!!layer.toGeoJSON) {
                            map.removeLayer(layer);
                        }
                    });
                    console.log('Cleared existing markers');
                    // Add new markers for each vehicle position
                    data.vehicles.forEach((vehicle, index) => {
                        if (!vehicle.latitude || !vehicle.longitude) {
                            console.warn('Invalid coordinates for vehicle:', vehicle);
                            return;
                        }
                        var lat = parseFloat(vehicle.latitude);
                        var lng = parseFloat(vehicle.longitude);
                        if (isNaN(lat) || isNaN(lng)) {
                            console.warn('Invalid coordinates for vehicle:', vehicle);
                            return;
                        }
                        var popupContent = `
                            <strong>Vehicle ID:</strong> ${vehicle.vehicle_id}<br>
                            <strong>Route ID:</strong> ${vehicle.route_id}<br>
                            <strong>Trip ID:</strong> ${vehicle.trip_id}<br>
                            <strong>Vehicle Label:</strong> ${vehicle.vehicle_label}<br>
                            <strong>Latitude:</strong> ${lat}<br>
                            <strong>Longitude:</strong> ${lng}
                        `;
                        L.marker([lat, lng]).addTo(map)
                            .bindPopup(popupContent);
                        if (index === 0) {
                            console.log('Added first marker for vehicle:', vehicle);
                        }
                    });
                    console.log('Finished adding markers');
                })
                .catch(error => console.error('Error fetching vehicle positions:', error));
        }

        // Initial map update
        updateMap();

        // Periodically update the map every 10 seconds
        setInterval(updateMap, 10000);
    </script>
</body>
</html>
